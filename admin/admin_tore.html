<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>トレーニングホーム</title>
    <link rel="stylesheet" href="styles/admin.css">
</head>
<body>
    <header>
        <!--左側メニュー-->
        <nav id="admin_nav">
            <ul>
                <li class="custom-button" id="user">
                    <a href="admin_home.html" class="button-link">ユーザー</a>
                </li>
                <li class="custom-button" id="eat">
                    <a href="admin_food.html" class="button-link">食事</a>
                </li>
                <li class="custom-button" id="tore">
                    <a href="admin_tore.html" class="button-link">トレーニング</a>
                </li>
            </ul>
        </nav>
        <!--/左側メニュー-->
    </header>
 
    <!--背景色-->
    <nav id="back">
        <button class="logout" onclick="location.href='../login/login.html';"></button>
 
        <select id="sortOption" onchange="sortArray()">
            <option value="asc">昇順</option>
            <option value="desc">降順</option>
        </select>

        <!-- トレーニングリスト -->
        <ul id="ToreList"></ul>
    </nav>

    <script>
        let ToreData = []; // トレーニングデータを一時的に保存する変数
        let UserData = {}; // ユーザーデータを辞書形式で保存する変数 (useridをキーとしてusernameにアクセス)

        // ユーザーデータを取得
        function fetchUsers() {
            return fetch('https://karadanipi-su-api.onrender.com/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ネットワークのエラーが発生しました');
                    }
                    return response.json();
                })
                .then(data => {
                    data.forEach(user => {
                        UserData[user.userid] = user.username; // ユーザーIDをキーに保存
                    });
                })
                .catch(error => {
                    console.error('ユーザーデータ取得エラー:', error);
                    alert('ユーザーデータの取得に失敗しました');
                });
        }

        // トレーニングデータを取得
        function fetchTore() {
            return fetch('https://karadanipi-su-api.onrender.com/trainings')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ネットワークのエラーが発生しました');
                    }
                    return response.json();
                })
                .then(data => {
                    ToreData = data; // トレーニングデータを保存
                    groupAndRenderToreList(ToreData); // グループ化して表示
                })
                .catch(error => {
                    console.error('データ取得エラー:', error);
                    alert('トレーニングデータの取得に失敗しました');
                });
        }

        // ページが読み込まれた際にデータを取得
        window.onload = function () {
            fetchUsers().then(fetchTore);
        };

        // データをグループ化して表示する関数
        function groupAndRenderToreList(data) {
            // グループ化
            const groupedData = data.reduce((acc, Tore) => {
                const username = UserData[Tore.userid] || '不明なユーザー';
                const date = Tore.created_at ? Tore.created_at.split('T')[0] : '日付なし'; // 日付取得
                const key = `${username}-${date}`; // ユーザー名と日付でキー生成

                if (!acc[key]) {
                    acc[key] = { username, date, exercises: [] };
                }
                acc[key].exercises.push(Tore); // トレーニングデータを追加
                return acc;
            }, {});

            renderGroupedToreList(Object.values(groupedData)); // グループ化したデータを表示
        }

        // グループ化されたデータを表示する関数
        function renderGroupedToreList(groupedData) {
            const ToreList = document.getElementById('ToreList');
            ToreList.innerHTML = ''; // リストを初期化

            groupedData.forEach(group => {
                // ユーザー名と日付のヘッダー
                const headerItem = document.createElement('li');
                headerItem.textContent = `ユーザー名: ${group.username} | 日付: ${group.date}`;
                headerItem.classList.add('header-item');
                headerItem.style.fontWeight = 'bold';
                headerItem.style.marginTop = '20px';

                ToreList.appendChild(headerItem);

                // トレーニング内容をリストアップ
                group.exercises.forEach(Tore => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        部位: ${Tore.part || '未設定'}<br>
                        エクササイズ: ${Tore.exercise || '未設定'}<br>
                        セット数: ${Tore.sets || '未設定'}セット
                    `;
                    listItem.classList.add('exercise-item');
                    listItem.style.paddingLeft = '20px'; // インデントを追加

                    ToreList.appendChild(listItem);
                });
            });
        }

        // 並び替え用の関数
        function sortArray() {
            const sortOption = document.getElementById('sortOption').value;
            const sortedData = [...ToreData].sort((a, b) => {
                const dateA = new Date(a.created_at);
                const dateB = new Date(b.created_at);
                return sortOption === 'asc' ? dateA - dateB : dateB - dateA;
            });
            groupAndRenderToreList(sortedData); // 並び替えたデータで表示を更新
        }
    </script>
</body>
</html>